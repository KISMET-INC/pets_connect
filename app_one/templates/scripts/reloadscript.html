<script>

// Variables from context
    var url_location = '{{location}}'
    var image = '{{image.id}}'
    var trig = '{{trigger}}'
    
//*********************************************//
// TRIGGERS FOR MODAL
// If the trigger value in the url is 1 reset
// the fade on the modal otherwise remove it
//*********************************************//

    if ('{{trigger}}' == '1'){
        $('#comment_modal').addClass('fade'); 
    } else {
        $('#comment_modal').removeClass('fade');
    }
    
//******************************************************//
// IF CURRENT IMAGE
// If there is a current image id in url when loading
// show the modal containing the information on the image
//******************************************************//

    if (image != 0 ){
        $('#comment_modal').modal('show');       
    }

//*********************************************//
// BULLETIN PAGE
// Heart not nested in bulletin page so it takes
// different targeting to function
//*********************************************//

    if(url_location == 'bulletin'){

        $( 'p button')
        .mouseover(function() {
            var img_id = $(this).attr('id');
            loadurl =`/${url_location}/{{session_user.id}}/${img_id}/0`    
        })
        .click(function() {
            window.history.pushState({}, '', loadurl)
            window.location.reload();
        })

        $('.fa-heart').click (function(){
            var img_id = $(this).attr('id');
            alert('click')
            $.ajax({
            cache: false,
            type:"GET",
            url: `/process_heart/${img_id}/{{location}}`,
            })
            .done(function(data){
                $(`#replace${img_id}`).html(data);                    
            })
            .fail(function(data){
                console.log("Error in fetching data");
            })
        })
    }

//*********************************************//
//  WHEN HIDING MODAL
//  When clicking off of the modal and it hides
//  adds the fade class back to the modal for
//  next time it is called on a new image
//*********************************************//

    $("#comment_modal").on('hidden.bs.modal', function(e){
            loadurl = `/${url_location}/{{session_user.id}}/0/0`
            window.history.pushState({}, '', loadurl)
            $('#comment_modal').addClass('fade');
    });
            var heart=false;


//*********************************************//
// WHEN CLICKING THE IMAGE
// When image is clicked it checks of the user is
// over the heart button using the heart boolean. 
// If so it makes an AJAX request get data to
// update the stats elements to represent new status
//*********************************************//        

    $('.dimage').click(function(){

        var img_id = $(this).attr('id');
        var replace = `#replace${img_id}`

        if(heart == true){
            $.ajax({
            cache: false,
            type:"GET",
            url: `/process_heart/${img_id}/{{location}}`,
            })
            .done(function(data){
                $(`#replace${img_id}`).html(data);                    
            })
            .fail(function(data){
                console.log("Error in fetching data");
            })
        }
        
    })
    

//*********************************************//
// ON MOUSEENTER
// When mouse enters the image it tracks if the mouse
// is over the heart button or not useing the heart
// bool and corresponding mouse enter mouse outs
//*********************************************//

    $( '.dimage' )
    .mouseenter(function() {
        // Declare Variables needed 
        var img_id = $(this).attr('id');
        var img = `.open_modal${img_id}`
        var stats = `#stat${img_id}`
        var replace = `#replace${img_id}`

        // Sets headers to an opacity of .99  so that they will mainain
        // their heirarchy
        $(".opacity").css('opacity', '.99');

        // Return URL with image ID to push for loading modal
        loadurl = `/${url_location}/{{session_user.id}}/${img_id}`

        // Decreases the opacity of the image.
        $( `${img}`)
        .css('opacity', '.6')
        // When image is clicked it pushes new URL and reloads page
        // to show modal. Work around to make modal appear as a chat
        .click(function(){
            window.history.pushState({}, '', loadurl+'/1')
            window.location.reload()          
        });

        // Comment button needs different opacity. Will DRY UP later
        $( `${img}x`).css('opacity', '1') .click(function(){
            window.history.pushState({}, '', loadurl+'/1')
            window.location.reload()          
        });

        // Show the stats
        $(`${stats}`).show()

        // Toggle heart boolean
        $('.fa-heart')
        .mouseenter(function(){
            heart = true;            
        }).mouseleave(function(){
            heart = false;
        })

    });

//*********************************************//
// ON MOUSEOUT
// Return image to normal opacity and hide stats
//*********************************************//

    $( ".dimage" )
    .mouseleave(function() {
        var id = $(this).attr('id');
        var stats = `#stat${id}`
        var img = `.open_modal${id}`

        $( `${img}`).css('opacity', '1')
        $(`${stats}`).hide()
    });


</script>